/**************************************************************** *  文件名     ： SendEmailDispatch.java *  日期         :  2012-12-27 *  Company: 上海绿岸网络科技有限公司 *  (C) Copyright Green Shore Network Technology Co.,Ltd.2012 *           		All Rights Reserved. *  注意： 本内容仅限于上海绿岸网络科技有限公司内部使用，禁止转发 ****************************************************************/package com.iwgame.xengine.xtask.email.worker.dispatch;import javax.annotation.Resource;import org.apache.log4j.Logger;import org.springframework.amqp.rabbit.core.RabbitTemplate;import com.iwgame.xengine.xtask.email.model.Mail;import com.iwgame.xengine.xtask.email.model.WeightModel;import com.iwgame.xengine.xtask.email.tools.calc.WeightCalculation;import com.iwgame.xengine.xtask.email.tools.utils.Constant;/** * @类名: EmailDispatch(邮件分发器[调度]) * @描述: 根据邮件通道的权重,邮件分发到不同的邮件提供商的队列 *  * @作者: 吴君杰 * @邮件: wujunjie@iwgame.com * @日期: 2012-12-27上午10:56:55 * @版本: 1.0 */public class DispatchEmailWroker {	private final Logger logger = Logger.getLogger(Constant.LOG4J_DISPATCH);	@Resource	private RabbitTemplate rabbitMailTemplate;	@Resource	private WeightCalculation weightCalculation;	public void dispatch(String source) {		logger.info("收到邮件请求:" + source);		try {			Mail mail = new Mail(source);			int channel_id = mail.getTemplateId();			String failed = mail.getFailed();			WeightModel weightModel = weightCalculation.getMaxWeight(channel_id, failed);			if (weightModel != null) {				String providerName = weightModel.getProvider_name();				if (providerName != null && !"".equals(providerName)) {					mail.setTemplateId(weightModel.getTemplate_id());					mail.setChannelid(weightModel.getChannel_id());					mail.setProvider(providerName);					rabbitMailTemplate.convertAndSend(Constant.EXCHANGE_MAIL, Constant.QUEUE_ROUTE_KEY + providerName, mail.toString());					logger.info("邮件分发到 [" + providerName + "] 队列成功!消息:" + mail.toString());				} else {					// 写日志					logger.error("忽略,邮件分发失败!获取邮件网管别名 [" + providerName + "] 为空!  请求消息 :" + source);				}			} else {				// 写日志				logger.error("忽略,未找到通道ID [" + channel_id + "] 的模板列表,获取权重对象为空,请检查! 消息:" + source);			}		} catch (Throwable e) {			logger.error("忽略,请求:" + source + ",分发邮件异常!", e);		}	}}